steps:
  - label: "Running tests in development environment"
    command: "auto/test"
    env:
      ENVIRONMENT: "DEV"
    agents:
      queue: 'eks-dataservices-agent-dev'
    artifact_paths:
      - "coverage.xml"
      - "py-test-report.xml"
      - "pylint-report.parseable"
  
  - wait

  - label: "Sonar scan :sonarqube:"
    agents:
      queue: "eks-dataservices-agent-dev"
    plugins:
      ssh://git@git.realestate.com.au/data-service-it/sonar-buildkite-plugin#3bc7522639db9a956bf5243e66fe6a0b55edd3f5:
        projectKey: "api-template"
        projectname: "API Template"
        coverage_exclusions: "**/tests/**"

  # - wait

  # - label: "Build Dev :docker: image"
  #   command: "auto/build"
  #   env:
  #     ENVIRONMENT: "DEV"
  #   agents:
  #     queue: 'eks-dataservices-agent-dev'
  #   branches: "master test-new-bk-agent"

  # - wait

  # - label: "Deploy to :kubernetes: Dev "
  #   command: "auto/deploy"
  #   env:
  #     ENVIRONMENT: "DEV"
  #   agents:
  #     queue: 'eks-dataservices-agent-dev'
  #   branches: "master test-new-bk-agent"

  - block: "Deploy to STAGING :kubernetes: Cluster!!!"
    branches: "master test-new-bk-agent"

  - label: "Running tests in staging environment"
    command: "auto/test"
    env:
      ENVIRONMENT: "STAGING"
    agents:
      queue: 'eks-dataservices-agent-staging'
    branches: "master test-new-bk-agent"

  - wait

  - label: "Build Staging :docker: image"
    command: "auto/build"
    env:
      ENVIRONMENT: "STAGING"
    agents:
      queue: 'eks-dataservices-agent-staging'
    branches: "master test-new-bk-agent"

  - wait

  - label: "Deploy to :kubernetes: Staging "
    command: "auto/deploy"
    env:
      ENVIRONMENT: "STAGING"
    agents:
      queue: 'eks-dataservices-agent-staging'
    branches: "master test-new-bk-agent"

  - block: "Deploy to Production :kubernetes: Cluster!!!"
    branches: "master test-new-bk-agent"

  - label: "Running tests in production environment"
    command: "auto/test"
    env:
      ENVIRONMENT: "PROD"
    agents:
      queue: 'eks-dataservices-agent-prod'
    branches: "master test-new-bk-agent"
  
  - wait

  - label: "Build Production :docker: image"
    command: "auto/build"
    env:
      ENVIRONMENT: "PROD"
    agents:
      queue: 'eks-dataservices-agent-prod'
    branches: "master test-new-bk-agent"

  - wait

  - label: "Deploy to :kubernetes: Production "
    command: "auto/deploy"
    env:
      ENVIRONMENT: "PROD"
    agents:
      queue: 'eks-dataservices-agent-prod'
    branches: "master test-new-bk-agent"